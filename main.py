# coding=utf-8
from pytg.sender import Sender
from pytg.receiver import Receiver
from pytg.utils import coroutine
from collections import deque
from time import time, sleep
from getopt import getopt
from datetime import datetime
import sys
import re
import _thread
import random
import pytz

# username –∏–≥—Ä–æ–≤–æ–≥–æ –±–æ—Ç–∞
bot_username = 'keeketheone'

# –≤–∞—à username –∏–ª–∏ username —á–µ–ª–æ–≤–µ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã —ç—Ç–æ–º—É —Å–∫—Ä–∏–ø—Ç—É
admin_username = ''

# username –±–æ—Ç–∞ –∏/–∏–ª–∏ —á–µ–ª–æ–≤–µ–∫–∞, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø—Ä–∏–∫–∞–∑—ã
order_usernames = ''

# –∏–º—è –∑–∞–º–∫–∞
castle_name = 'blue'


# –ø—É—Ç—å –∫ —Å–æ–∫–µ—Ç —Ñ–∞–π–ª—É
socket_path = ''

# —Ö–æ—Å—Ç —á—Ç–æ–± —Å–ª—É—à–∞—Ç—å telegram-cli
host = 'localhost'

# –ø–æ—Ä—Ç –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É —Å–ª—É—à–∞—Ç—å
port = 1338

# —Å–∫–∏–¥—ã–≤–∞–Ω–∏–µ –¥–µ–Ω–µ–≥ –ø–æ–∫—É–ø–∫–æ–π/–ø—Ä–æ–¥–∞–∂–µ–π —à–ª–µ–º–æ–≤
donate_buying = False

# –≤–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–∫–∞—á–∫—É –ø—Ä–∏ –ª–µ–≤–µ–ª–∞–ø–µ
lvl_up = 'lvl_off'

# –∏–º—è –≥—Ä—É–ø–ø—ã
group_name = ''

opts, args = getopt(sys.argv[1:], 'a:o:c:s:h:p:g:b:l:n', ['admin=', 'order=', 'castle=', 'socket=', 'host=', 'port=',
                                                          'gold=', 'buy=', 'lvlup=', 'group_name='])

for opt, arg in opts:
    if opt in ('-a', '--admin'):
        admin_username = arg
    elif opt in ('-o', '--order'):
        order_usernames = arg.split(',')
    elif opt in ('-c', '--castle'):
        castle_name = arg
    elif opt in ('-s', '--socket'):
        socket_path = arg
    elif opt in ('-h', '--host'):
        host = arg
    elif opt in ('-p', '--port'):
        port = int(arg)
    elif opt in ('-g', '--gold'):
        gold_to_left = int(arg)
    elif opt in ('-b', '--buy'):
        donate_buying = bool(arg)
    elif opt in ('-l', '--lvlup'):
        lvl_up = arg
    elif opt in ('-n', '--group_name'):
        group_name = arg



orders = {
    'red': 'üáÆüá≤',
    'black': 'üá¨üáµ',
    'white': 'üá®üáæ',
    'yellow': 'üáªüá¶',
    'blue': 'üá™üá∫',
    'mint': 'üá≤üá¥',
    'twilight': 'üá∞üáÆ',
    'lesnoi_fort': 'üå≤–õ–µ—Å–Ω–æ–π —Ñ–æ—Ä—Ç',
    'les': 'üå≤–õ–µ—Å',
    'gorni_fort': '‚õ∞–ì–æ—Ä–Ω—ã–π —Ñ–æ—Ä—Ç',
    'gora': '‚õ∞',
    'cover': 'üõ° –ó–∞—â–∏—Ç–∞',
    'attack': '‚öî –ê—Ç–∞–∫–∞',
    'cover_symbol': 'üõ°',
    'hero': 'üèÖ–ì–µ—Ä–æ–π',
    'corovan': '/go',
    'peshera': 'üï∏–ü–µ—â–µ—Ä–∞',
    'quests': 'üó∫ –ö–≤–µ—Å—Ç—ã',
    'lvl_def': '+1 üõ°–ó–∞—â–∏—Ç–∞',
    'lvl_atk': '+1 ‚öîÔ∏è–ê—Ç–∞–∫–∞',
    'lvl_off': '–í—ã–∫–ª—é—á–µ–Ω'
}


arena_cover = ['üõ°–≥–æ–ª–æ–≤—ã', 'üõ°–∫–æ—Ä–ø—É—Å–∞', 'üõ°–Ω–æ–≥']
arena_attack = ['üó°–≤ –≥–æ–ª–æ–≤—É', 'üó°–ø–æ –∫–æ—Ä–ø—É—Å—É', 'üó°–ø–æ –Ω–æ–≥–∞–º']
# –ø–æ–º–µ–Ω—è—Ç—å blue –Ω–∞ red, black, white, yellow –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∞—à–µ–≥–æ –∑–∞–º–∫–∞
castle = orders[castle_name]
# —Ç–µ–∫—É—â–∏–π –ø—Ä–∏–∫–∞–∑ –Ω–∞ –∞—Ç–∞–∫—É/–∑–∞—â–∏—Ç—É, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—Å–µ–≥–¥–∞ –∑–∞—â–∏—Ç–∞, —Ç—Ä–æ–≥–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ
current_order = {'time': 0, 'order': castle}
# –∑–∞–¥–∞–µ–º –ø–æ–ª—É—á–∞—Ç–µ–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –±–æ—Ç–∞: –∞–¥–º–∏–Ω –∏–ª–∏ –≥—Ä—É–ø–ø–∞
if group_name =='':
    pref = '@'
    msg_receiver = admin_username
else:
    pref = ''
    msg_receiver = group_name

sender = Sender(sock=socket_path) if socket_path else Sender(host=host,port=port)
action_list = deque([])
log_list = deque([], maxlen=30)
lt_arena = 0
get_info_diff = 360
hero_message_id = 0
last_captcha_id = 0
gold_to_left = 0

bot_enabled = True
arena_enabled = False
les_enabled = False
peshera_enabled = False
corovan_enabled = True
order_enabled = False
auto_def_enabled = False
donate_enabled = False
quest_fight_enabled = False

arena_running = False
arena_delay = False
arena_delay_day = -1
tz = pytz.timezone('Europe/Moscow')

@coroutine
def work_with_message(receiver):
    while True:
        msg = (yield)
        try:
            if msg['event'] == 'message' and 'text' in msg and msg['peer'] is not None:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —é–∑–µ—Ä–Ω–µ–π–º–∞, —á—Ç–æ–±—ã –Ω–µ –≤—ã–≤–∞–ª–∏–≤–∞–ª—Å—è Exception
                if 'username' in msg['sender']:
                    parse_text(msg['text'], msg['sender']['username'], msg['id'])
        except Exception as err:
            log('–û—à–∏–±–∫–∞ coroutine: {0}'.format(err))


def queue_worker():
    global get_info_diff
    global arena_delay
    global arena_delay_day
    global tz
    lt_info = 0
    # –≥—Ä–µ–±–∞–Ω–∞—è –º–∞–≥–∏—è
    print(sender.contacts_search(bot_username))
    sleep(3)
    while True:
        try:
            if time() - lt_info > get_info_diff:
                if arena_delay and arena_delay_day != datetime.now(tz).day:
                    arena_delay = False
                lt_info = time()
                get_info_diff = random.randint(12600, 14400)
                if bot_enabled:
                    send_msg('@', bot_username, orders['hero'])
                continue

            if len(action_list):
                log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º ' + action_list[0])
                send_msg('@', bot_username, action_list.popleft())
            sleep_time = random.randint(2, 5)
            sleep(sleep_time)
        except Exception as err:
            log('–û—à–∏–±–∫–∞ –æ—á–µ—Ä–µ–¥–∏: {0}'.format(err))


def parse_text(text, username, message_id):
    global lt_arena
    global hero_message_id
    global bot_enabled
    global arena_enabled
    global les_enabled
    global peshera_enabled
    global corovan_enabled
    global order_enabled
    global auto_def_enabled
    global donate_enabled
    global donate_buying
    global last_captcha_id
    global arena_delay
    global arena_delay_day
    global tz
    global arena_running
    global lvl_up
    global pref
    global msg_receiver
    global quest_fight_enabled
    if bot_enabled and username == bot_username:
        log('–ü–æ–ª—É—á–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞. –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è')

        if corovan_enabled and text.find(' –ø—ã—Ç–∞–µ—Ç—Å—è –æ–≥—Ä–∞–±–∏—Ç—å') != -1:
            action_list.append(orders['corovan'])

            # –í–∫–ª/–≤—ã–∫–ª –±–æ—Ç–∞
            elif text == '#enable_bot':
                bot_enabled = True
                send_msg(pref, msg_receiver, '–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –≤–∫–ª—é—á–µ–Ω')
            elif text == '#disable_bot':
                bot_enabled = False
                send_msg(pref, msg_receiver, '–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –≤—ã–∫–ª—é—á–µ–Ω')

            # –í–∫–ª/–≤—ã–∫–ª –∞—Ä–µ–Ω—ã
            elif text == '#enable_arena':
                arena_enabled = True
                send_msg(pref, msg_receiver, '–ê—Ä–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ –≤–∫–ª—é—á–µ–Ω–∞')
            elif text == '#disable_arena':
                arena_enabled = False
                send_msg(pref, msg_receiver, '–ê—Ä–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ –≤—ã–∫–ª—é—á–µ–Ω–∞')

            # –í–∫–ª/–≤—ã–∫–ª –ª–µ—Å–∞
            elif text == '#enable_les':
                les_enabled = True
                send_msg(pref, msg_receiver, '–õ–µ—Å —É—Å–ø–µ—à–Ω–æ –≤–∫–ª—é—á–µ–Ω')
            elif text == '#disable_les':
                les_enabled = False
                send_msg(pref, msg_receiver, '–õ–µ—Å —É—Å–ø–µ—à–Ω–æ –≤—ã–∫–ª—é—á–µ–Ω')

            # –í–∫–ª/–≤—ã–∫–ª –ø–µ—â–µ—Ä—ã
            elif text == '#enable_peshera':
                peshera_enabled = True
                send_msg(pref, msg_receiver, '–ü–µ—â–µ—Ä—ã —É—Å–ø–µ—à–Ω–æ –≤–∫–ª—é—á–µ–Ω—ã')
            elif text == '#disable_peshera':
                peshera_enabled = False
                send_msg(pref, msg_receiver, '–ü–µ—â–µ—Ä—ã —É—Å–ø–µ—à–Ω–æ –≤—ã–∫–ª—é—á–µ–Ω—ã')

            # –í–∫–ª/–≤—ã–∫–ª –∫–æ—Ä–æ–≤–∞–Ω–∞
            elif text == '#enable_corovan':
                corovan_enabled = True
                send_msg(pref, msg_receiver, '–ö–æ—Ä–æ–≤–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ –≤–∫–ª—é—á–µ–Ω—ã')
            elif text == '#disable_corovan':
                corovan_enabled = False
                send_msg(pref, msg_receiver, '–ö–æ—Ä–æ–≤–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ –≤—ã–∫–ª—é—á–µ–Ω—ã')

            # –í–∫–ª/–≤—ã–∫–ª –∫–æ–º–∞–Ω–¥
            elif text == '#enable_order':
                order_enabled = True
                send_msg(pref, msg_receiver, '–ü—Ä–∏–∫–∞–∑—ã —É—Å–ø–µ—à–Ω–æ –≤–∫–ª—é—á–µ–Ω—ã')
            elif text == '#disable_order':
                order_enabled = False
                send_msg(pref, msg_receiver, '–ü—Ä–∏–∫–∞–∑—ã —É—Å–ø–µ—à–Ω–æ –≤—ã–∫–ª—é—á–µ–Ω—ã')

            # –í–∫–ª/–≤—ã–∫–ª –∞–≤—Ç–æ –¥–µ—Ñ
            elif text == '#enable_auto_def':
                auto_def_enabled = True
                send_msg(pref, msg_receiver, '–ê–≤—Ç–æ –¥–µ—Ñ —É—Å–ø–µ—à–Ω–æ –≤–∫–ª—é—á–µ–Ω')
            elif text == '#disable_auto_def':
                auto_def_enabled = False
                send_msg(pref, msg_receiver, '–ê–≤—Ç–æ –¥–µ—Ñ —É—Å–ø–µ—à–Ω–æ –≤—ã–∫–ª—é—á–µ–Ω')

            # –í–∫–ª/–≤—ã–∫–ª –∞–≤—Ç–æ –¥–æ–Ω–∞—Ç
            elif text == '#enable_donate':
                donate_enabled = True
                send_msg(pref, msg_receiver, '–î–æ–Ω–∞—Ç —É—Å–ø–µ—à–Ω–æ –≤–∫–ª—é—á–µ–Ω')
            elif text == '#disable_donate':
                donate_enabled = False
                send_msg(pref, msg_receiver, '–î–æ–Ω–∞—Ç —É—Å–ø–µ—à–Ω–æ –≤—ã–∫–ª—é—á–µ–Ω')

            # –í–∫–ª/–≤—ã–∫–ª –¥–æ–Ω–∞—Ç –≤ –ª–∞–≤–∫—É
            elif text == '#enable_buy':
                donate_buying = True
                send_msg(pref, msg_receiver, '–î–æ–Ω–∞—Ç –≤ –ª–∞–≤–∫—É —É—Å–ø–µ—à–Ω–æ –≤–∫–ª—é—á–µ–Ω')
            elif text == '#disable_buy':
                donate_buying = False
                send_msg(pref, msg_receiver, '–î–æ–Ω–∞—Ç –≤ –ª–∞–≤–∫—É —É—Å–ø–µ—à–Ω–æ –≤—ã–∫–ª—é—á–µ–Ω')

            # –í–∫–ª/–≤—ã–∫–ª –±–∏—Ç–≤—É –ø–æ –≤—Ä–µ–º—è –∫–≤–µ—Å—Ç–∞
            elif text == '#enable_quest_fight':
                quest_fight_enabled = True
                send_msg(pref, msg_receiver, '–ë–∏—Ç–≤–∞ –≤–∫–ª—é—á–µ–Ω–∞')
            elif text == '#disable_quest_fight':
                quest_fight_enabled = False
                send_msg(pref, msg_receiver, '–ë–∏—Ç–≤–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞')

            # —á—Ç–æ –∫–∞—á–∞—Ç—å –ø—Ä–∏ –ª–µ–≤–µ–ª–∞–ø–µ
            elif text == '#lvl_atk':
                lvl_up = 'lvl_atk'
                send_msg(pref, msg_receiver, '–ö–∞—á–∞–µ–º –∞—Ç–∞–∫—É')
            elif text == '#lvl_def':
                lvl_up = 'lvl_def'
                send_msg(pref, msg_receiver, '–ö–∞—á–∞–µ–º –∑–∞—â–∏—Ç—É')
            elif text == '#lvl_off':
                lvl_up = 'lvl_off'
                send_msg(pref, msg_receiver, '–ù–µ –∫–∞—á–∞–µ–º –Ω–∏—á–µ–≥–æ')

            # –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å
            elif text == '#status':
                send_msg(pref, msg_receiver, '\n'.join([
                    'ü§ñ–ë–æ—Ç –≤–∫–ª—é—á–µ–Ω: {0}',
                    'üìØ–ê—Ä–µ–Ω–∞ –≤–∫–ª—é—á–µ–Ω–∞: {1}',
                    'üîé–°–µ–π—á–∞—Å –Ω–∞ –∞—Ä–µ–Ω–µ: {2}',
                    'üå≤–õ–µ—Å –≤–∫–ª—é—á–µ–Ω: {3}',
                    'üï∏–ü–µ—â–µ—Ä—ã –≤–∫–ª—é—á–µ–Ω—ã: {4}',
                    'üê´–ö–æ—Ä–æ–≤–∞–Ω—ã –≤–∫–ª—é—á–µ–Ω—ã: {5}',
                    'üá™üá∫–ü—Ä–∏–∫–∞–∑—ã –≤–∫–ª—é—á–µ–Ω—ã: {6}',
                    'üõ°–ê–≤—Ç–æ –¥–µ—Ñ –≤–∫–ª—é—á–µ–Ω: {7}',
                    'üí∞–î–æ–Ω–∞—Ç –≤–∫–ª—é—á–µ–Ω: {8}',
                    'üèö–î–æ–Ω–∞—Ç –≤ –ª–∞–≤–∫—É –≤–º–µ—Å—Ç–æ –∫–∞–∑–Ω—ã: {9}',
                    'üåü–õ–µ–≤–µ–ª–∞–ø: {10}',
                ]).format(bot_enabled, arena_enabled, arena_running, les_enabled, peshera_enabled, corovan_enabled, order_enabled, 
                          auto_def_enabled, donate_enabled, donate_buying,orders[lvl_up]))

            # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥–µ—Ä–æ–µ
            elif text == '#hero':
                if hero_message_id == 0:
                    send_msg(pref, msg_receiver, '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥–µ—Ä–æ–µ –ø–æ–∫–∞ –µ—â–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞')
                else:
                    fwd(pref, msg_receiver, hero_message_id)

            # –ü–æ–ª—É—á–∏—Ç—å –ª–æ–≥
            elif text == '#log':
                send_msg(pref, msg_receiver, '\n'.join(log_list))
                log_list.clear()

            elif text == '#lt_arena':
                send_msg(pref, msg_receiver, str(lt_arena))

            elif text == '#order':
                text_date = datetime.fromtimestamp(current_order['time']).strftime('%Y-%m-%d %H:%M:%S')
                send_msg(pref, msg_receiver, current_order['order'] + ' ' + text_date)

            elif text == '#time':
                text_date = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                send_msg(pref, msg_receiver, text_date)

            elif text == '#ping':
                send_msg(pref, msg_receiver, '#pong')

            elif text == '#get_info_diff':
                send_msg(pref, msg_receiver, str(get_info_diff))

            elif text.startswith('#push_order'):
                command = text.split(' ')[1]
                if command in orders:
                    update_order(orders[command])
                    send_msg(pref, msg_receiver, '–ö–æ–º–∞–Ω–¥–∞ ' + command + ' –ø—Ä–∏–º–µ–Ω–µ–Ω–∞')
                else:
                    send_msg(pref, msg_receiver, '–ö–æ–º–∞–Ω–¥–∞ ' + command + ' –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞')

            elif text.startswith('#captcha'):
                command = text.split(' ')[1]
                if command in captcha_answers:
                    action_list.append(captcha_answers[command])
                    bot_enabled = True
                    send_msg('@', admin_username, '–ö–æ–º–∞–Ω–¥–∞ ' + command + ' –ø—Ä–∏–º–µ–Ω–µ–Ω–∞')
                else:
                    send_msg('@', admin_username, '–ö–æ–º–∞–Ω–¥–∞ ' + command + ' –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞')


def send_msg(pref, to, message):
    sender.send_msg(pref + to, message)


def fwd(pref, to, message_id):
    sender.fwd(pref + to, message_id)


def update_order(order):
    current_order['order'] = order
    current_order['time'] = time()
    if order == castle:
        action_list.append(orders['cover'])
    else:
        action_list.append(orders['attack'])
    action_list.append(order)


def log(text):
    message = '{0:%Y-%m-%d %H:%M:%S}'.format(datetime.now()) + ' ' + text
    print(message)
    log_list.append(message)


if __name__ == '__main__':
    receiver = Receiver(sock=socket_path) if socket_path else Receiver(port=port)
    receiver.start()  # start the Connector.
    _thread.start_new_thread(queue_worker, ())
    receiver.message(work_with_message(receiver))
    receiver.stop()
